<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AsiaX Colours Game</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#38d3f1;
      --muted:#9aa7b2;
      --glass: rgba(255,255,255,0.03);
    }
    * {box-sizing:border-box;font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    html,body {height:100%;margin:0;background:linear-gradient(180deg,#071224 0%, #0b1b2a 100%);color:#e6f0f6}
    .app {max-width:420px;margin:30px auto;padding:18px}
    .card {background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:16px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.6);backdrop-filter:blur(6px)}
    header {display:flex;align-items:center;gap:12px}
    
    .logo-btn {
      width:64px;height:64px;border-radius:12px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;animation: spin 15s linear infinite;box-shadow:0 4px 15px rgba(56,211,241,0.2);
      transition: all 0.3s ease;border: none;background: none;padding: 0;
    }
    .logo-btn:hover {
      transform: scale(1.1) !important;
      box-shadow: 0 0 25px rgba(56,211,241,0.5);
    }
    .logo-btn img {width:100%;height:100%;border-radius:12px;object-fit:cover;pointer-events:none}

    .title {font-size:28px;font-weight:800}
    .subtitle {font-size:12px;color:var(--muted);margin-top:2px}
    .balance {display:flex;justify-content:space-between;align-items:center;margin-top:14px}
    .bal-left {font-size:13px;color:var(--muted)}
    .bal-amount {font-weight:700;font-size:18px}
    .controls {display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
    .input, .select, .btn {
      width:100%;padding:12px;border-radius:12px;
      border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:15px
    }
    .bet-row {display:flex;gap:8px;margin-top:12px}
    .small {font-size:12px;color:var(--muted)}
    .result {margin-top:35px;text-align:center}
    .result .text {font-weight:700;font-size:16px;margin-bottom:8px}
    .connect {
      padding:10px 16px;border-radius:10px;border:0;
      background:linear-gradient(90deg,var(--accent),#02f823);color:#000;font-weight:700;font-size:14px
    }
    .play {
      padding:12px;border-radius:12px;border:0;background:#1352ff;color:#fff;
      font-weight:800;flex:1;margin-left:8px;font-size:16px
    }
    .color-box {
      width:80px;height:80px;border-radius:12px;display:flex;align-items:center;justify-content:center;
      font-weight:700;color:#fff;font-size:14px;box-shadow:0 4px 10px rgba(0,0,0,0.3)
    }
    .red {background:#ef4444}
    .green {background:#22c55e}
    .yellow {background:#fbbf24;color:#000}
    .blue {background:#3b82f6}
    .winner {
      border:4px solid #fff !important;
      box-shadow:0 0 30px #fff !important;
      transform:scale(1.1);
      animation:glow 1.5s infinite alternate
    }
    @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    @keyframes glow {from{box-shadow:0 0 20px #fff} to{box-shadow:0 0 40px #fff, 0 0 60px currentColor}}
    button:disabled {opacity:0.6; cursor:not-allowed}
  </style>
</head>
<body>

<div class="app">
  <div class="card">
    <header>
      <button class="logo-btn" onclick="goHome()" title="Go to Home">
        <img src="axcoin.png" alt="AsiaX Logo">
      </button>
      <div>
        <div class="title">ùïè ùïîùï†ùïùùï†ùï¶ùï£ùï§ ùïòùïíùïûùïñ</div>
        <div class="subtitle">Fast. Simple. Fair</div>
      </div>
    </header>
    <div class="balance">
      <div>
        <div class="bal-left">Your Balance</div>
        <div class="bal-amount" id="balance">0.00 AX</div>
      </div>
      <div style="color:var(--muted);font-size:12px">
        Player: <span id="playerAddr" style="color:#38d3f1">Not connected</span>
      </div>
    </div>

    <div class="controls">
      <select id="choice" class="select">
        <option value="0">Red</option>
        <option value="1">Green</option>
        <option value="2">Yellow</option>
        <option value="3">Blue</option>
      </select>
      <input id="bet" class="input" type="number" min="0.1" step="0.1" placeholder="Bet amount" value="10">
    </div>

    <div class="bet-row">
      <button class="connect" id="connectBtn" onclick="connectWallet()">Connect</button>
      <button class="connect" id="approveBtn" onclick="approveTokens()" style="display:none">Approve</button>
      <button class="play" id="playBtn" onclick="playGame()">Play</button>
    </div>

    <div class="result">
      <div id="gameResult" class="text">Select colour & play</div>
      <div class="small">Winning colour will glow</div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <div id="box0" class="color-box red">Red</div>
        <div id="box1" class="color-box green">Green</div>
        <div id="box2" class="color-box yellow">Yellow</div>
        <div id="box3" class="color-box blue">Blue</div>
      </div>
    </div>
  </div>
</div>

<script>
  function goHome() {
    window.location.href = "ASIAX.PRO";  // ‚Üê‚Üê YAHAN APNA HOME URL DAAL DO
    // Ya agar same site pe different page hai to: "index.html" ya "/" daal do
  }
  // ‚Üê‚Üê END ‚Üí‚Üí

  let provider, signer, userAccount;
  let tokenContract, gameContract;
  let isApproved = false;

  const TOKEN_ADDRESS = "0xE36b5223d488322fAc2dDda937E5aB226E83Fbbd";
  const GAME_ADDRESS = "0x0C181e6366E1f8a6667a38593bA126DBCb42dCd1";

  const tokenABI = [
    "function balanceOf(address) view returns (uint256)",
    "function allowance(address owner, address spender) view returns (uint256)",
    "function approve(address spender, uint256 amount) external returns (bool)"
  ];
  const gameABI = [
    "function play(uint256 amount, uint8 choice) external",
    "event ColourResult(address indexed player, uint256 amount, bool win, uint256 payout, uint8 random, uint8 playerChoice)"
  ];

  async function connectWallet() {
    if (!window.ethereum) return alert("MetaMask not detected!");
    try {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAccount = await signer.getAddress();

      tokenContract = new ethers.Contract(TOKEN_ADDRESS, tokenABI, signer);
      gameContract = new ethers.Contract(GAME_ADDRESS, gameABI, signer);

      const shortAddr = userAccount.slice(0,6) + "..." + userAccount.slice(-4);
      document.getElementById("playerAddr").innerText = shortAddr;
      document.getElementById("connectBtn").innerText = "Connected";

      await Promise.all([updateBalance(), checkAllowance()]);
      setupEventListener();
    } catch (err) {
      alert("Connection failed!");
    }
  }

  async function updateBalance() {
    if (!userAccount) return;
    try {
      const bal = await tokenContract.balanceOf(userAccount);
      document.getElementById("balance").innerText = parseFloat(ethers.utils.formatUnits(bal, 18)).toFixed(2) + " AX";
    } catch (e) {}
  }

  async function checkAllowance() {
    if (!userAccount) return;
    const allowance = await tokenContract.allowance(userAccount, GAME_ADDRESS);
    const hasEnough = allowance.gte(ethers.utils.parseUnits("1000", 18));
    isApproved = hasEnough;const approveBtn = document.getElementById("approveBtn");
    if (!hasEnough) {
      approveBtn.style.display = "block";
      approveBtn.innerText = "Approve AX";
    } else {
      approveBtn.style.display = "none";
    }
  }

  async function approveTokens() {
    const btn = document.getElementById("approveBtn");
    btn.disabled = true;
    btn.innerText = "Approving...";

    try {
      const tx = await tokenContract.approve(GAME_ADDRESS, ethers.constants.MaxUint256);
      await tx.wait();
      isApproved = true;
      btn.style.display = "none";
      alert("Approval successful! You can now play freely");
    } catch (err) {
      btn.disabled = false;
      btn.innerText = "Approve AX";
      alert("Approval failed or rejected");
    }
  }

  function setupEventListener() {
    gameContract.on("ColourResult", (player, amount, win, payout, random) => {
      if (player.toLowerCase() !== userAccount.toLowerCase()) return;

      document.querySelectorAll(".color-box").forEach(b => b.classList.remove("winner"));
      document.getElementById("box" + random).classList.add("winner");

      if (win) {
        document.getElementById("gameResult").innerHTML = `You WON ${ethers.utils.formatUnits(payout, 18)} AX!`;
      } else {
        document.getElementById("gameResult").innerHTML = `Lost this round! Try again`;
      }
      updateBalance();
    });
  }

  async function playGame() {
    if (!userAccount) return alert("Connect wallet first!");
    if (!isApproved) return alert("Please approve AX tokens first!");

    const choice = document.getElementById("choice").value;
    const betVal = parseFloat(document.getElementById("bet").value);
    if (!betVal || betVal < 0.1) return alert("Minimum bet 0.1 AX");

    const playBtn = document.getElementById("playBtn");
    playBtn.disabled = true;
    playBtn.innerText = "Playing...";

    try {
      const amount = ethers.utils.parseUnits(betVal.toString(), 18);
      const tx = await gameContract.play(amount, choice);
      document.getElementById("gameResult").innerText = "Transaction sent... waiting for result";
      await tx.wait();
    } catch (err) {
      alert("Transaction failed: " + (err.reason || err.message || "Rejected"));
      playBtn.disabled = false;
      playBtn.innerText = "Play";
    }
  }

  setInterval(() => { if (userAccount) updateBalance(); }, 8000);
</script>
</body>
</html>
